services:
  db:
    image: bitnami/postgresql:latest
    environment:
      POSTGRESQL_DATABASE: ${DATABASE_NAME}
      POSTGRESQL_USERNAME: ${DATABASE_USER}
      POSTGRESQL_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRESQL_POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRESQL_ENABLE_POSTGIS: "yes"
    volumes:
      - dbdata:/bitnami/postgresql
      - ./backend/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test:
        ["CMD-SHELL", "pg_isready -U $DATABASE_USER -d $DATABASE_NAME"]
      interval: 5s
      timeout: 3s
      retries: 20

  db-test:
    profiles: ["test"]
    image: bitnami/postgresql:latest
    environment:
      POSTGRESQL_DATABASE: hivehand_test
      POSTGRESQL_USERNAME: hivedev
      POSTGRESQL_PASSWORD: verysafe
      POSTGRESQL_POSTGRES_PASSWORD: verysafe
      POSTGRESQL_ENABLE_POSTGIS: "yes"
    volumes:
      - dbdata-test:/bitnami/postgresql
      - ./backend/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hivedev -d hivehand_test"]
      interval: 5s
      timeout: 3s
      retries: 20

  migrate:
    image: bitnami/postgresql:latest
    restart: "no" # to allow migration to re run everytime docker is built
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://hivedev:verysafe@db:5432/hivehand
    volumes:
      - ./backend/migrations:/migrations:ro
    entrypoint: ["/bin/bash","-lc"]
    #set -e allows migration to exit with non zero code when a migration fails
    command: >
      'set -e;   
      for f in /migrations/*.sql; do
        echo "Applying $$f";
        psql "$$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$$f";
      done;
      echo "Migrations applied."'

  migrate-test:
    image: bitnami/postgresql:latest
    profiles: ["test"]
    depends_on:
      db-test:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://hivedev:verysafe@db-test:5432/hivehand_test
    volumes:
      - ./backend/migrations:/migrs:ro
    entrypoint: ["/bin/bash","-lc"]
    command: >
      'for f in /migrations/*.sql; do
        echo "Applying $$f";
        psql "$$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$$f";
      done;
      echo "Test migrations applied."'

  # migrate:
  #   image: bitnami/postgresql:latest
  #   depends_on:
  #     db:
  #       condition: service_healthy
  #   environment:
  #     DATABASE_URL: postgres://hivedev:verysafe@db:5432/hivehand
  #   volumes:
  #     - ./backend/migrations:/migrations:ro
  #       entrypoint: ["/bin/bash","-lc"]
  #       command: >'for f in /migrations/*.sql; do
  #       echo "Applying $$f";
  #       psql "$$DATABASE_URL" -v ON_ERROR_STOP=1 -f "$$f";
  #       done;
  #       echo "Migrations applied."'

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    # Load extra app secrets (JWTs, etc.)
    env_file:
      - ./backend/.env
    environment:
      # Compose builds this from root .env vars above
      DATABASE_URL: postgres://${DATABASE_USER}:${DATABASE_PASSWORD}@db:${PGPORT:-5432}/${DATABASE_NAME}
      PGHOST: db
      PGPORT: ${PGPORT}
      PGDATABASE: ${DATABASE_NAME}
      PGUSER: ${DATABASE_USER}
      PGPASSWORD: ${DATABASE_PASSWORD}
      PORT: ${BACKEND_PORT}
      NODE_ENV: ${NODE_ENV}
      PUBLIC_BASE_URL: http://localhost:${BACKEND_PORT}
    volumes:
      - ./backend:/backend:cached 
      - /backend/node_modules
      - zodgen:/backend/src/spec # comment out for rerunning openapi file
      - ./backend:/backend       # ^ same
      - /backend/node_modules
      - uploads:/uploads # for pic upload
    depends_on:
      db:
        condition: service_healthy
      migrate: 
        condition: service_started #service_completed_successfully
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      VITE_API_URL: ${VITE_API_URL}
    volumes:
      - ./frontend:/frontend:delegated
      - /frontend/node_modules   
    depends_on:
      backend:
        condition: service_started
    ports:
      - "${FRONTEND_PORT}:${FRONTEND_PORT}"
    command: ["npm","run","dev","--","--host","0.0.0.0","--port","${FRONTEND_PORT}","--strictPort"]

  test:
    profiles: ["test"]                 # only runs when you ask for it
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: test
      # IMPORTANT: point to the *container* DB host ("db"), not localhost
      DATABASE_URL: postgres://${DATABASE_USER}:${DATABASE_PASSWORD}@db-test:5432/hivehand_test
    depends_on:
      migrate-test:
        condition: service_completed_successfully
    # Run all tests; or change to "npm run test:integration" if you want only integration
    command: ["npm","test","--","--runInBand"]

volumes:
  dbdata:
  dbdata-test:
  zodgen:
  uploads: #pic uploads